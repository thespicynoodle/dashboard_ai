<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>USA Drug Deaths Dashboard (1990–2019)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --navy-900: #0b1b33;
      --navy-800: #0f274a;
      --navy-700: #163660;
      --navy-600: #1f4a7a;
      --navy-500: #2a5f99;
      --navy-300: #6f9ed4;
      --navy-100: #e9f0fb;
      --white: #ffffff;
      --muted: #6c757d;
      --success: #2e7d32;
      --danger: #b71c1c;
      --shadow: 0 8px 24px rgba(11,27,51,0.12);
      --shadow-soft: 0 2px 8px rgba(11,27,51,0.08);
    }

    body {
      background: linear-gradient(180deg, var(--navy-900) 0%, var(--navy-800) 100%);
      color: var(--white);
      min-height: 100vh;
    }

    .app-header {
      padding: 2.5rem 0 1.5rem;
    }

    .brand-badge {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: #cfe1ff;
      font-weight: 600;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-size: .75rem;
      padding: .25rem .5rem;
      border-radius: .25rem;
    }

    .title {
      font-weight: 700;
      letter-spacing: .2px;
      margin: .5rem 0 .25rem;
    }

    .subtitle {
      color: #dbe7ff;
      opacity: .9;
      max-width: 900px;
    }

    .uploader {
      background: rgba(255,255,255,0.06);
      border: 1px dashed rgba(255,255,255,0.25);
      border-radius: .5rem;
      padding: 1rem 1.25rem;
      color: #e6eeff;
    }

    .uploader input[type="file"] {
      color-scheme: dark;
    }

    .content {
      background: var(--white);
      color: #122033;
      border-radius: 1rem 1rem 0 0;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .metric-card {
      border: 0;
      border-radius: .75rem;
      box-shadow: var(--shadow-soft);
      height: 100%;
      background: linear-gradient(180deg, #ffffff 0%, #f9fbff 100%);
    }
    .metric-card .card-body { padding: 1.25rem 1.25rem; }
    .metric-title { font-size: .9rem; color: #5b6b84; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
    .metric-value { font-size: 1.75rem; font-weight: 800; color: var(--navy-700); }
    .metric-sub { font-size: .85rem; color: #6a7c96; }

    .delta-up { color: var(--success); font-weight: 700; }
    .delta-down { color: var(--danger); font-weight: 700; }

    .chart-card {
      border: 0;
      border-radius: .75rem;
      box-shadow: var(--shadow-soft);
      height: 100%;
      background: #ffffff;
    }
    .chart-card .card-header {
      background: linear-gradient(180deg, #f6f9ff 0%, #eef3fb 100%);
      border-bottom: 1px solid #e1e8f5;
      color: var(--navy-700);
      font-weight: 700;
    }
    .chart-wrapper {
      position: relative;
      height: 360px;
      padding: .75rem;
    }

    .placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7c8da8;
      font-weight: 600;
      background: repeating-linear-gradient(
        45deg,
        rgba(15,39,74,0.03),
        rgba(15,39,74,0.03) 10px,
        rgba(15,39,74,0.06) 10px,
        rgba(15,39,74,0.06) 20px
      );
      border-radius: .5rem;
    }

    .alert-area .alert {
      margin-top: 1rem;
    }

    footer {
      color: #c9d7f0;
      padding: 1.25rem 0 2rem;
      font-size: .9rem;
    }

    @media (max-width: 991.98px) {
      .chart-wrapper { height: 320px; }
    }
    @media (max-width: 575.98px) {
      .chart-wrapper { height: 280px; }
      .metric-value { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="app-header">
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="brand-badge">USA Public Health</span>
        <span class="badge rounded-pill text-bg-light">1990–2019</span>
      </div>
      <h1 class="title display-6">USA Drug Deaths Dashboard (1990–2019)</h1>
      <p class="subtitle">Focused on drugs_deaths for the United States of America from 1990 to 2019. All visuals are restricted to location_name = “United States of America” and the years 1990–2019.</p>

      <div class="uploader d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mt-3">
        <div class="d-flex align-items-center gap-3">
          <div class="text-nowrap fw-semibold">Upload CSV:</div>
          <input id="csvInput" type="file" accept=".csv" class="form-control form-control-sm" />
        </div>
        <div class="small text-light opacity-75">
          Select updated_names_copy.csv. Required columns: location_name, year, age_name, drugs_deaths.
        </div>
      </div>

      <div id="alertArea" class="alert-area"></div>
    </header>

    <!-- Content -->
    <main class="content">
      <!-- Metrics Row -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-4">
          <div class="card metric-card">
            <div class="card-body">
              <div class="metric-title">Total Drug Deaths (1990–2019, USA)</div>
              <div id="cardTotal" class="metric-value mt-1">—</div>
              <div class="metric-sub">Sum of drug-related deaths across all ages and sexes in the USA, 1990–2019.</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card metric-card">
            <div class="card-body">
              <div class="metric-title">2019 Drug Deaths (USA)</div>
              <div id="card2019" class="metric-value mt-1">—</div>
              <div class="metric-sub">Total drug-related deaths in the USA in 2019.</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card metric-card">
            <div class="card-body">
              <div class="metric-title">Change vs 1990</div>
              <div id="cardDelta" class="metric-value mt-1">—</div>
              <div class="metric-sub">Percent change in total drug deaths from 1990 to 2019 in the USA.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card chart-card h-100">
            <div class="card-header">USA Drug Deaths by Year (1990–2019)</div>
            <div class="card-body">
              <div class="chart-wrapper">
                <canvas id="chartYear"></canvas>
                <div id="phYear" class="placeholder">Upload CSV to render</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card chart-card h-100">
            <div class="card-header">Age-Group Trends (1990–2019, USA)</div>
            <div class="card-body">
              <div class="chart-wrapper">
                <canvas id="chartAgeTrend"></canvas>
                <div id="phAgeTrend" class="placeholder">Upload CSV to render</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card chart-card h-100">
            <div class="card-header">2019 Drug Deaths by Age Group (USA)</div>
            <div class="card-body">
              <div class="chart-wrapper">
                <canvas id="chartAge2019"></canvas>
                <div id="phAge2019" class="placeholder">Upload CSV to render</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="text-center">
      Built with Bootstrap 5, Chart.js, and Papa Parse. All figures filter to United States of America, 1990–2019.
    </footer>
  </div>

  <script>
    // Globals for charts (to allow destroy before recreate)
    let chartYearLine = null;
    let chartAgeArea = null;
    let chartAgeBar = null;

    const REQUIRED_COLUMNS = ['location_name','year','age_name','drugs_deaths'];
    const USA_NAME = 'United States of America';
    const YEAR_START = 1990;
    const YEAR_END = 2019;

    const alertArea = document.getElementById('alertArea');

    // Utility: Alerts
    function showAlert(message, type = 'danger', autoDismissMs = 8000) {
      const id = 'alert-' + Math.random().toString(36).slice(2);
      const el = document.createElement('div');
      el.className = `alert alert-${type} alert-dismissible fade show`;
      el.id = id;
      el.role = 'alert';
      el.innerHTML = `
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      alertArea.appendChild(el);
      if (autoDismissMs) {
        setTimeout(() => {
          const alert = bootstrap.Alert.getOrCreateInstance(document.getElementById(id));
          alert?.close();
        }, autoDismissMs);
      }
    }

    // Utility: Numbers
    const fmtNumber = (n) => (typeof n === 'number' && isFinite(n)) ? n.toLocaleString('en-US') : '—';
    const fmtCompact = (n) => (typeof n === 'number' && isFinite(n)) ? Intl.NumberFormat('en', {notation:'compact', maximumFractionDigits:1}).format(n) : '—';
    const fmtPercent = (n) => (typeof n === 'number' && isFinite(n)) ? `${n >= 0 ? '+' : ''}${n.toFixed(2)}%` : '—';

    // CSV parsing
    function parseCSV(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (results.errors && results.errors.length > 0) {
              reject(new Error('CSV parse error: ' + results.errors[0].message));
            } else {
              resolve(results.data);
            }
          },
          error: (err) => reject(err)
        });
      });
    }

    // Validation
    function validateColumns(rows) {
      if (!rows || !rows.length) {
        throw new Error('CSV has no data rows.');
      }
      const cols = Object.keys(rows[0] || {});
      const missing = REQUIRED_COLUMNS.filter(c => !cols.includes(c));
      if (missing.length) {
        throw new Error('Missing required columns: ' + missing.join(', '));
      }
    }

    // Filter to USA and years
    function filterUSA1990to2019(rows) {
      return rows
        .filter(r => r && r.location_name === USA_NAME && isFinite(+r.year))
        .filter(r => +r.year >= YEAR_START && +r.year <= YEAR_END)
        .map(r => ({
          location_name: r.location_name,
          year: +r.year,
          age_name: String(r.age_name ?? '').trim(),
          drugs_deaths: safeNumber(r.drugs_deaths)
        }))
        .filter(r => isFinite(r.drugs_deaths));
    }

    function safeNumber(v){
      const n = typeof v === 'string' ? Number(v.replace(/,/g,'')) : Number(v);
      return isFinite(n) ? n : NaN;
    }

    // Aggregation helpers
    function sumBy(arr, keyFn, valueFn) {
      const m = new Map();
      for (const row of arr) {
        const k = keyFn(row);
        const v = valueFn(row);
        m.set(k, (m.get(k) || 0) + v);
      }
      return m;
    }

    // Age label ordering
    function ageOrderValue(label) {
      const raw = (label || '').toString().trim();
      const l = raw.toLowerCase();

      // Exclude aggregate groups by sending to Infinity
      if (['all ages','age-standardized','age standardized','both sexes'].includes(l)) return Infinity;

      // Neonatal mappings if present
      const neonateMap = {
        'early neonatal': 0.0,
        'late neonatal': 0.05,
        'post neonatal': 0.1,
        'neonatal': 0.08
      };
      if (neonateMap[l] !== undefined) return neonateMap[l];

      // Under X
      const underMatch = l.match(/^under\s+(\d+)/);
      if (underMatch) return 0;

      // X to Y (allow hyphens or en-dashes)
      const toMatch = l.match(/^(\d+)\s*(?:to|–|-)\s*(\d+)/);
      if (toMatch) return parseInt(toMatch[1], 10);

      // X plus or X+
      const plusMatch = l.match(/^(\d+)\s*(?:\+|plus)/);
      if (plusMatch) return parseInt(plusMatch[1], 10);

      // Single number start
      const startNum = l.match(/^(\d+)/);
      if (startNum) return parseInt(startNum[1], 10);

      // Fallback: try extract any number
      const anyNum = l.match(/(\d+)/);
      if (anyNum) return parseInt(anyNum[1], 10);

      // Unknown labels at the end
      return Number.POSITIVE_INFINITY;
    }

    function sortAgesYoungToOld(ageLabels) {
      return [...ageLabels]
        .filter(l => ageOrderValue(l) !== Infinity)
        .sort((a,b) => {
          const av = ageOrderValue(a), bv = ageOrderValue(b);
          if (av !== bv) return av - bv;
          return a.localeCompare(b); // tie-breaker stable
        });
    }

    // Palette generator (navy blues with varying lightness and alpha)
    function colorForIndex(i, total) {
      const hue = 212; // navy-blue hue
      const minL = 28, maxL = 74; // lightness range
      const l = minL + ( (maxL - minL) * (i / Math.max(1, total - 1)) );
      const base = `hsl(${hue}deg 56% ${l}%)`;
      // Convert to rgba-ish by using alpha in CSS color-4 syntax supported by Chart.js via ctx
      return {
        stroke: base,
        fill: `hsl(${hue}deg 56% ${l}% / 0.18)`
      };
    }

    function setPlaceholders(visible) {
      ['phYear','phAgeTrend','phAge2019'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = visible ? 'flex' : 'none';
      });
    }

    function destroyCharts() {
      [chartYearLine, chartAgeArea, chartAgeBar].forEach(ch => { try { ch?.destroy(); } catch(e) {} });
      chartYearLine = chartAgeArea = chartAgeBar = null;
    }

    // Main render
    async function handleFile(file) {
      try {
        setPlaceholders(true);
        destroyCharts();
        updateMetricsPlaceholders();

        const rows = await parseCSV(file);
        validateColumns(rows);
        const data = filterUSA1990to2019(rows);

        if (!data.length) {
          showAlert('No rows found for United States of America in years 1990–2019.', 'warning', 10000);
          return;
        }

        // Metrics
        const totalAll = data.reduce((a,b) => a + b.drugs_deaths, 0);
        const total2019 = data.filter(r => r.year === 2019).reduce((a,b) => a + b.drugs_deaths, 0);
        const total1990 = data.filter(r => r.year === 1990).reduce((a,b) => a + b.drugs_deaths, 0);
        const pctChange = (total1990 === 0) ? NaN : ((total2019 - total1990) / total1990) * 100;

        // Update cards
        document.getElementById('cardTotal').textContent = fmtNumber(totalAll);
        document.getElementById('card2019').textContent = fmtNumber(total2019);
        const deltaEl = document.getElementById('cardDelta');
        deltaEl.textContent = fmtPercent(pctChange);
        deltaEl.classList.remove('delta-up','delta-down');
        if (isFinite(pctChange)) {
          deltaEl.classList.add(pctChange >= 0 ? 'delta-up' : 'delta-down');
        }

        // Yearly line chart
        const years = Array.from({length: (YEAR_END - YEAR_START + 1)}, (_,i) => YEAR_START + i);
        const byYear = sumBy(data, r => r.year, r => r.drugs_deaths);
        const yearValues = years.map(y => byYear.get(y) || 0);

        const yearCtx = document.getElementById('chartYear').getContext('2d');
        chartYearLine = new Chart(yearCtx, {
          type: 'line',
          data: {
            labels: years,
            datasets: [{
              label: 'All ages & sexes (USA)',
              data: yearValues,
              borderColor: '#1f4a7a',
              backgroundColor: 'rgba(31,74,122,0.15)',
              pointRadius: 2.5,
              pointHoverRadius: 5,
              borderWidth: 2.5,
              tension: 0.25,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 8 },
            plugins: {
              legend: { display: true, labels: { color: '#24364f', font: { weight: 600 } } },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${fmtNumber(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#476084' },
                grid: { color: 'rgba(23,42,69,0.08)' }
              },
              y: {
                ticks: {
                  color: '#476084',
                  callback: (v) => fmtCompact(v)
                },
                grid: { color: 'rgba(23,42,69,0.08)' }
              }
            }
          }
        });

        // Age group trends (stacked area)
        const ageSet = new Set(data.map(r => r.age_name));
        const agesOrdered = sortAgesYoungToOld(Array.from(ageSet));
        const totalAges = agesOrdered.length;

        const datasetsAge = agesOrdered.map((age, idx) => {
          const color = colorForIndex(idx, totalAges);
          const seriesByYear = new Map();
          for (const r of data) {
            if (r.age_name === age) {
              seriesByYear.set(r.year, (seriesByYear.get(r.year) || 0) + r.drugs_deaths);
            }
          }
          const series = years.map(y => seriesByYear.get(y) || 0);
          return {
            label: age,
            data: series,
            borderColor: color.stroke,
            backgroundColor: color.fill,
            pointRadius: 0,
            borderWidth: 1.7,
            tension: 0.25,
            fill: true,
            stack: 'ageStack'
          };
        });

        const ageTrendCtx = document.getElementById('chartAgeTrend').getContext('2d');
        chartAgeArea = new Chart(ageTrendCtx, {
          type: 'line',
          data: {
            labels: years,
            datasets: datasetsAge
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 8 },
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#24364f', font: { size: 11 } }
              },
              tooltip: {
                mode: 'nearest',
                intersect: false,
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${fmtNumber(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              x: {
                stacked: true,
                ticks: { color: '#476084' },
                grid: { color: 'rgba(23,42,69,0.06)' }
              },
              y: {
                stacked: true,
                ticks: { color: '#476084', callback: (v) => fmtCompact(v) },
                grid: { color: 'rgba(23,42,69,0.06)' }
              }
            }
          }
        });

        // Age groups (2019) bar
        const data2019 = data.filter(r => r.year === 2019);
        const byAge2019 = sumBy(data2019, r => r.age_name, r => r.drugs_deaths);
        const ageLabels2019 = agesOrdered.filter(a => byAge2019.has(a));
        const ageValues2019 = ageLabels2019.map(a => byAge2019.get(a) || 0);

        const age2019Ctx = document.getElementById('chartAge2019').getContext('2d');
        chartAgeBar = new Chart(age2019Ctx, {
          type: 'bar',
          data: {
            labels: ageLabels2019,
            datasets: [{
              label: 'Drug deaths (2019)',
              data: ageValues2019,
              backgroundColor: 'rgba(31,74,122,0.65)',
              borderColor: '#1f4a7a',
              borderWidth: 1.5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 8 },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${fmtNumber(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: '#476084',
                  maxRotation: 45,
                  minRotation: 0,
                  autoSkip: true
                },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#476084', callback: (v) => fmtCompact(v) },
                grid: { color: 'rgba(23,42,69,0.08)' }
              }
            }
          }
        });

        // Hide placeholders after successful render
        setPlaceholders(false);

        // Success notice
        showAlert('Data loaded and dashboard rendered for United States of America (1990–2019).', 'success', 5000);

      } catch (err) {
        console.error(err);
        showAlert(err.message || 'An unexpected error occurred while processing the file.', 'danger', 12000);
      }
    }

    function updateMetricsPlaceholders() {
      document.getElementById('cardTotal').textContent = '—';
      document.getElementById('card2019').textContent = '—';
      const deltaEl = document.getElementById('cardDelta');
      deltaEl.textContent = '—';
      deltaEl.classList.remove('delta-up','delta-down');
    }

    // Wire up file input
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please upload a valid CSV file.', 'warning', 7000);
        return;
      }
      handleFile(file);
    });

    // Chart.js defaults
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji'";
    Chart.defaults.color = '#24364f';
  </script>

  <!-- Bootstrap JS (for alerts close) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>